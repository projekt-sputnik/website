---
import BaseLayout from "../layouts/BaseLayout.astro";
import HorizontalCard from "../components/HorizontalCard.astro";
import { getCollection } from "astro:content";
import createSlug from "../lib/createSlug"

const posts = (await getCollection("blog")).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const last_posts = posts.slice(0, 3);

const response = await fetch('https://shodan.nyc3.digitaloceanspaces.com/exposure-data/US.json');
const data = await response.json();

---

<BaseLayout sideBarActiveItemID="home">
    
     <div class="card w-100 bg-base-100 shadow-xl">
        <figure><img src="/pingmap.png" /></figure>
        <div class="card-body">
          <h2 class="card-title">{data['geoRegion']} Internet Exposure</h2>
         <div class="stats stats-vertical lg:stats-horizontal shadow">
          <div class="stat">
            <div class="stat-title">Compromised Databases</div>
            <div class="stat-value">{data['numCompromisedDB'].toLocaleString() }</div>
          </div>
          <div class="stat">
            <div class="stat-title">Industrial Control Systems</div>
            <div class="stat-value">{data['numIcs'].toLocaleString() }</div>
          </div>

          <div class="stat">
            <div class="stat-title">Open Ports</div>
            <div class="stat-value">{data['numPorts'].toLocaleString() }</div>
          </div>
          <div class="stat">
            <div class="stat-title">Open Webcams</div>
            <div class="stat-value">{data['numOpenWebcams'].toLocaleString() }</div>
          </div>
		  <div class="stat">
            <div class="stat-title">Top Vulnerability</div>
            <div class="stat-value">{data['vuln'].toLocaleString() }</div>
          </div>
	  </div>
	</div>
</div>

<div class="card w-100 bg-base-100 shadow-xl">
  <div>
    <div class="text-2xl w-full font-bold mb-5 mt-10">Posts</div>
  </div>

  {
    last_posts.map((post) => (
      <>
        <HorizontalCard
          title={post.data.title}
          img={post.data.heroImage}
          desc={post.data.description}
          url={"/blog/" + createSlug(post.data.title, post.slug)}
          target="_self"
          badge={post.data.badge}
        />
        <div class="divider my-0" />
      </>
    ))
  }
  
</div>
</BaseLayout>
